<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stylist Pipeline Runner</title>
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            color: #000000;
            min-height: 100vh;
            padding: 20px;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #000000;
            font-weight: 600;
        }
        .container {
            display: flex;
            gap: 20px;
            max-width: 1600px;
            margin: 0 auto;
            min-height: calc(100vh - 100px);
        }
        .panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #ffffff;
            border: 1px solid #E5E7EB;
            border-radius: 10px;
            padding: 20px;
        }
        .panel h2 {
            margin-bottom: 15px;
            color: #000000;
            font-size: 1.2rem;
            font-weight: 600;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #6B7280;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        textarea, input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #E5E7EB;
            border-radius: 6px;
            background: #F9FAFB;
            color: #000000;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            resize: vertical;
        }
        textarea:focus, input[type="text"]:focus {
            outline: none;
            border-color: #000000;
        }
        .input-group {
            margin-bottom: 15px;
        }
        #productText {
            flex: 1;
            min-height: 200px;
        }
        #resultJson {
            min-height: 200px;
            margin-top: 16px;
        }
        button {
            background: #000000;
            color: #ffffff;
            border: none;
            padding: 15px 30px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 15px;
        }
        button:hover {
            background: #333333;
        }
        button:disabled {
            background: #9CA3AF;
            cursor: not-allowed;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 6px;
            font-size: 14px;
            border: 1px solid #E5E7EB;
        }
        .status.loading {
            background: #F9FAFB;
            color: #6B7280;
        }
        .status.success {
            background: #F9FAFB;
            color: #000000;
        }
        .status.error {
            background: #F9FAFB;
            color: #000000;
            border-color: #000000;
        }

        /* Style V2 Result Display */
        .result-display {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 13px;
            color: #111827;
        }
        .score-badge {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding: 12px;
            background: #F9FAFB;
            border-radius: 10px;
            border: 1px solid #E5E7EB;
        }
        .score-number {
            font-size: 32px;
            font-weight: 700;
            color: #000000;
            line-height: 1;
        }
        .verdict-chip {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: #ffffff;
            background: #000000;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .confidence-text {
            font-size: 11px;
            color: #6B7280;
            margin-top: 4px;
        }
        .headline {
            font-size: 15px;
            font-weight: 600;
            color: #000000;
            margin-bottom: 8px;
            line-height: 1.4;
        }
        .pinch-text {
            font-size: 13px;
            color: #374151;
            margin-bottom: 16px;
            line-height: 1.6;
        }
        .section-title {
            font-weight: 600;
            font-size: 12px;
            color: #6B7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        .goal-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 16px;
        }
        .goal-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 500;
            background: #F9FAFB;
            color: #000000;
            border: 1px solid #E5E7EB;
        }
        .goal-chip.helping {
            background: #ffffff;
            border-color: #000000;
        }
        .goal-chip.fighting {
            background: #000000;
            color: #ffffff;
        }
        .goal-chip.mixed {
            background: #E5E7EB;
        }
        .goal-analysis {
            margin-bottom: 16px;
        }
        .goal-item {
            padding: 8px 10px;
            margin-bottom: 6px;
            border-radius: 8px;
            background: #F9FAFB;
            border: 1px solid #E5E7EB;
        }
        .goal-item.pass {
            border-left: 3px solid #22C55E;
        }
        .goal-item.fail {
            border-left: 3px solid #EF4444;
        }
        .goal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2px;
        }
        .goal-name {
            font-weight: 600;
            font-size: 12px;
        }
        .goal-score {
            font-size: 11px;
            font-weight: 600;
        }
        .goal-reasoning {
            font-size: 10px;
            color: #6B7280;
            margin-top: 2px;
        }
        .collapsible {
            margin-top: 8px;
        }
        .collapsible summary {
            font-size: 11px;
            color: #9CA3AF;
            cursor: pointer;
            user-select: none;
            padding: 4px 0;
        }
        .collapsible summary:hover {
            color: #000000;
        }
        .collapsible-content {
            background: #F9FAFB;
            padding: 12px;
            border-radius: 8px;
            margin-top: 8px;
            max-height: 300px;
            overflow: auto;
            border: 1px solid #E5E7EB;
        }
        .collapsible pre {
            white-space: pre-wrap;
            word-break: break-word;
            font-size: 10px;
            line-height: 1.4;
            color: #374151;
            margin: 0;
        }
        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            gap: 16px;
        }
        .spinner {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 3px solid #E5E7EB;
            border-top: 3px solid #000000;
            animation: spin 1s linear infinite;
        }
        .not-supported {
            text-align: center;
            padding: 40px 20px;
            color: #6B7280;
        }
        .user-line {
            font-size: 11px;
            color: #9CA3AF;
            margin-bottom: 16px;
            font-style: italic;
        }

        /* Product Selector Styles */
        .product-selector {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #E5E7EB;
        }
        .product-selector-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        .product-dropdown-wrapper {
            flex: 1;
            position: relative;
        }
        .product-search-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #E5E7EB;
            border-radius: 6px;
            background: #F9FAFB;
            color: #000000;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
        }
        .product-search-input:focus {
            outline: none;
            border-color: #000000;
        }
        .product-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 300px;
            overflow-y: auto;
            background: #ffffff;
            border: 1px solid #E5E7EB;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            display: none;
        }
        .product-dropdown.open {
            display: block;
        }
        .product-option {
            padding: 10px 12px;
            cursor: pointer;
            font-size: 13px;
            border-bottom: 1px solid #F3F4F6;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .product-option:last-child {
            border-bottom: none;
        }
        .product-option:hover {
            background: #F9FAFB;
        }
        .product-option-name {
            flex: 1;
        }
        .product-option-thumb {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            object-fit: contain;
            margin-right: 10px;
            background: #F3F4F6;
            flex-shrink: 0;
        }
        .product-option-thumb-placeholder {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            margin-right: 10px;
            background: #F3F4F6;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9CA3AF;
            font-size: 10px;
        }
        .product-delete-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.5;
            transition: all 0.15s;
            margin: 0;
        }
        .product-delete-btn:hover {
            opacity: 1;
            background: #FEE2E2;
        }
        .product-delete-btn svg {
            width: 14px;
            height: 14px;
            stroke: #DC2626;
        }
        .product-option.add-new {
            font-weight: 600;
            color: #000000;
            background: #F3F4F6;
        }
        .product-option.add-new:hover {
            background: #E5E7EB;
        }
        .product-option.selected {
            background: #000000;
            color: #ffffff;
        }
        .add-product-section {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #F9FAFB;
            border-radius: 8px;
            border: 1px solid #E5E7EB;
        }
        .add-product-section.visible {
            display: block;
        }
        .add-product-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        .product-name-input-wrapper {
            flex: 1;
        }
        .btn-secondary {
            background: #ffffff;
            color: #000000;
            border: 1px solid #000000;
        }
        .btn-secondary:hover {
            background: #F9FAFB;
        }
        .btn-small {
            padding: 10px 20px;
            font-size: 13px;
            margin-top: 0;
        }

        /* Image Preview Styles */
        .image-preview-container {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #E5E7EB;
        }
        .image-preview-container label {
            display: block;
            margin-bottom: 8px;
        }
        .image-preview {
            max-width: 200px;
            max-height: 250px;
            border-radius: 8px;
            border: 1px solid #E5E7EB;
            object-fit: contain;
            background: #F9FAFB;
        }

        /* User Selector Styles */
        .user-selector {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #E5E7EB;
        }
        .user-dropdown-wrapper {
            flex: 1;
            position: relative;
        }
        .user-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 300px;
            overflow-y: auto;
            background: #ffffff;
            border: 1px solid #E5E7EB;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            display: none;
        }
        .user-dropdown.open {
            display: block;
        }

        /* User Measurement Form */
        .user-form-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #E5E7EB;
        }
        .user-form-section h3 {
            font-size: 14px;
            font-weight: 600;
            color: #000000;
            margin-bottom: 12px;
        }
        .measurement-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        .measurement-item {
            display: flex;
            flex-direction: column;
        }
        .measurement-item label {
            font-size: 10px;
            margin-bottom: 4px;
        }
        .measurement-item input {
            padding: 8px;
            font-size: 12px;
            border: 1px solid #E5E7EB;
            border-radius: 4px;
            background: #F9FAFB;
        }
        .measurement-item input:focus {
            outline: none;
            border-color: #000000;
        }

        /* Styling Goals Checkboxes */
        .styling-goals-section {
            margin-top: 15px;
        }
        .styling-goals-section h4 {
            font-size: 12px;
            font-weight: 600;
            color: #6B7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }
        .goals-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        .goal-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: #374151;
            cursor: pointer;
        }
        .goal-checkbox input[type="checkbox"] {
            width: 14px;
            height: 14px;
            cursor: pointer;
            accent-color: #000000;
        }
        .goal-checkbox.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .goal-checkbox.disabled input {
            cursor: not-allowed;
        }
        .goals-hint {
            font-size: 10px;
            color: #9CA3AF;
            margin-top: 6px;
        }

        /* Add User Section */
        .add-user-section {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #F9FAFB;
            border-radius: 8px;
            border: 1px solid #E5E7EB;
        }
        .add-user-section.visible {
            display: block;
        }
    </style>
</head>
<body>
    <h1>Stylist Pipeline Runner</h1>
    <div class="container">
        <div class="panel">
            <h2>Input</h2>

            <!-- Product Selector -->
            <div class="product-selector">
                <label>Select Product</label>
                <div class="product-selector-row">
                    <div class="product-dropdown-wrapper">
                        <input type="text" id="productSearchInput" class="product-search-input" placeholder="Search or select a product..." autocomplete="off">
                        <div id="productDropdown" class="product-dropdown"></div>
                    </div>
                </div>

                <!-- Add Product Section (shown when "Add Product" is selected) -->
                <div id="addProductSection" class="add-product-section">
                    <div class="add-product-row">
                        <div class="product-name-input-wrapper">
                            <label for="productNameInput">Product Name</label>
                            <input type="text" id="productNameInput" placeholder="Enter product name...">
                        </div>
                        <button id="saveProductBtn" class="btn-small" onclick="saveProduct()">Save Product</button>
                        <button id="cancelAddBtn" class="btn-small btn-secondary" onclick="cancelAddProduct()">Cancel</button>
                    </div>
                </div>
            </div>

            <div class="input-group">
                <label for="productText">Product Text</label>
                <textarea id="productText" placeholder="Paste product description here...">Title:
H&M Puff-Sleeved Dress
$29.99

Color:
Cream/floral

Product features
The model is 175cm/5'9" and wears a size S
Slim fit

Description & fit
Short dress in airy, woven fabric with smocking at back. Sweetheart neckline, slim fit over bust, and a gathered seam below bust. Narrow elastic over shoulders, short puff sleeves, and narrow elastic at cuffs. Gently flared skirt with a gathered seam above hem.

Art. No.: 1275471004

Concept:            DIVIDED
Description:        Cream/blue/green, Floral
Model size:         The model is 175cm/5'9" and wears a size S
Length:             Short
Sleeve Length:      Short sleeve
Fit:                Slim fit
Style:              Babydoll , Flared, Smocked, Romantic Dress
Neckline:           Sweetheart Neckline
Sleeve type:        Puff Sleeve
Imported:           Yes
Quantity:           Single

Materials

Composition
Shell:Rayon 70%, Linen 30%
Lining:Polyester 100%

Additional material information
The total weight of this product contains at least:
67% Livaeco™ Viscose

We exclude the weight of minor components such as, but not exclusively: threads, buttons, zippers, embellishments and prints.
The total weight of the product is calculated by adding the weight of all layers and main components together. Based on that, we calculate how much of that weight is made out by each material. For sets and multipacks, all pieces are counted together as one product in calculations.

Materials in this product explained

Rayon
Viscose is a regenerated cellulose fibre commonly made from wood, but the raw material could also consist of other cellulosic materials.

Livaeco™ Viscose
Livaeco™ is a branded viscose fiber. Its wood pulp raw material is sourced from certified forests according to standards regulating deforestation, wages and work environment, the protection of plant and animal species and community rights.

Polyester
Polyester is a synthetic fibre made from crude oil (a fossil resource).

Linen
Linen is a natural bast fibre derived from flax plants.

Care guide
Bring your clean, previously loved clothing or textiles to one of our stores — they can be from any brand.
Read about how you can make your clothes last longer
Care instructions
Use a laundry bag
Only non-chlorine bleach when needed
Line dry
Medium iron
Machine wash cold</textarea>
            </div>
            <div class="input-group">
                <label for="productImageUrl">Product Image URL</label>
                <input type="text" id="productImageUrl" value="https://image.hm.com/assets/hm/3f/9d/3f9d33623815e9442d3af8801b1bdcc619a18f8c.jpg?imwidth=1536">
            </div>
            <div class="input-group" style="margin-bottom: 10px;">
                <label class="goal-checkbox" style="display: inline-flex; font-size: 13px; text-transform: none;">
                    <input type="checkbox" id="useCacheCheckbox" checked>
                    Use cached attributes (if available)
                </label>
            </div>
            <button id="runBtn" onclick="runPipeline()">Run Pipeline</button>
            <div id="status" class="status" style="display: none;"></div>

            <!-- Image Preview -->
            <div id="imagePreviewContainer" class="image-preview-container" style="display: none;">
                <label>Image Preview</label>
                <img id="imagePreview" class="image-preview" alt="Product preview">
            </div>

            <!-- User Form Section -->
            <div class="user-form-section">
                <h3>User Measurements</h3>

                <!-- User Selector -->
                <div class="user-selector">
                    <label>Select User</label>
                    <div class="product-selector-row">
                        <div class="user-dropdown-wrapper">
                            <input type="text" id="userSearchInput" class="product-search-input" placeholder="Search or select a user..." autocomplete="off">
                            <div id="userDropdown" class="user-dropdown"></div>
                        </div>
                    </div>

                    <!-- Add User Section -->
                    <div id="addUserSection" class="add-user-section">
                        <div class="add-product-row">
                            <div class="product-name-input-wrapper">
                                <label for="userNameInput">User Name</label>
                                <input type="text" id="userNameInput" placeholder="Enter user name...">
                            </div>
                            <button id="saveUserBtn" class="btn-small" onclick="saveUser()">Save User</button>
                            <button id="cancelAddUserBtn" class="btn-small btn-secondary" onclick="cancelAddUser()">Cancel</button>
                        </div>
                    </div>
                </div>

                <!-- Measurements Grid -->
                <div class="measurement-grid">
                    <div class="measurement-item">
                        <label>Chest (cm)</label>
                        <input type="number" id="chest_circumference" step="0.1" value="112.7">
                    </div>
                    <div class="measurement-item">
                        <label>Waist (cm)</label>
                        <input type="number" id="waist_circumference" step="0.1" value="102.76">
                    </div>
                    <div class="measurement-item">
                        <label>Hip (cm)</label>
                        <input type="number" id="hip_circumference" step="0.1" value="107.5">
                    </div>
                    <div class="measurement-item">
                        <label>Shoulder (cm)</label>
                        <input type="number" id="shoulder_breadth" step="0.1" value="42.32">
                    </div>
                    <div class="measurement-item">
                        <label>Neck (cm)</label>
                        <input type="number" id="neck_circumference" step="0.1" value="44.97">
                    </div>
                    <div class="measurement-item">
                        <label>Thigh (cm)</label>
                        <input type="number" id="thigh_left_circumference" step="0.1" value="67.01">
                    </div>
                    <div class="measurement-item">
                        <label>Ankle (cm)</label>
                        <input type="number" id="ankle_left_circumference" step="0.1" value="28.64">
                    </div>
                    <div class="measurement-item">
                        <label>Arm Length (cm)</label>
                        <input type="number" id="arm_right_length" step="0.1" value="76.0">
                    </div>
                    <div class="measurement-item">
                        <label>Inseam (cm)</label>
                        <input type="number" id="inside_leg_height" step="0.1" value="77.66">
                    </div>
                    <div class="measurement-item">
                        <label>Height (cm)</label>
                        <input type="number" id="height" step="0.1" value="172.72">
                    </div>
                </div>

                <!-- Styling Goals -->
                <div class="styling-goals-section">
                    <h4>Styling Goals (select up to 3)</h4>
                    <div class="goals-grid">
                        <label class="goal-checkbox">
                            <input type="checkbox" name="styling_goal" value="look_taller" checked>
                            Look Taller
                        </label>
                        <label class="goal-checkbox">
                            <input type="checkbox" name="styling_goal" value="look_slimmer" checked>
                            Look Slimmer
                        </label>
                        <label class="goal-checkbox">
                            <input type="checkbox" name="styling_goal" value="highlight_waist">
                            Highlight Waist
                        </label>
                        <label class="goal-checkbox">
                            <input type="checkbox" name="styling_goal" value="hide_midsection">
                            Hide Midsection
                        </label>
                        <label class="goal-checkbox">
                            <input type="checkbox" name="styling_goal" value="minimize_hips">
                            Minimize Hips
                        </label>
                        <label class="goal-checkbox">
                            <input type="checkbox" name="styling_goal" value="balance_shoulders">
                            Balance Shoulders
                        </label>
                        <label class="goal-checkbox">
                            <input type="checkbox" name="styling_goal" value="hide_upper_arms">
                            Hide Upper Arms
                        </label>
                        <label class="goal-checkbox">
                            <input type="checkbox" name="styling_goal" value="elongate_legs">
                            Elongate Legs
                        </label>
                        <label class="goal-checkbox">
                            <input type="checkbox" name="styling_goal" value="create_curves">
                            Create Curves
                        </label>
                        <label class="goal-checkbox">
                            <input type="checkbox" name="styling_goal" value="streamline_silhouette">
                            Streamline Silhouette
                        </label>
                        <label class="goal-checkbox">
                            <input type="checkbox" name="styling_goal" value="minimize_bust">
                            Minimize Bust
                        </label>
                        <label class="goal-checkbox">
                            <input type="checkbox" name="styling_goal" value="show_legs">
                            Show Legs
                        </label>
                    </div>
                    <div class="goals-hint">Select up to 3 styling goals</div>
                </div>
            </div>
        </div>
        <div class="panel">
            <h2>Result</h2>
            <div id="resultDisplay" class="result-display"></div>
            <label style="margin-top: 16px;">Raw JSON</label>
            <textarea id="resultJson" readonly placeholder="Pipeline result will appear here..."></textarea>
        </div>
    </div>

    <script>
        // Product Selector State
        let products = [];
        let selectedProductIndex = -1;
        let isAddingNew = false;

        // User Selector State
        let users = [];
        let selectedUserIndex = -1;
        let isAddingNewUser = false;

        // Load products and users on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await loadProducts();
            await loadUsers();
            setupProductDropdown();
            setupUserDropdown();
            setupStylingGoals();
            setupImagePreview();
            updateImagePreview(); // Show preview if there's an initial URL
        });

        function setupImagePreview() {
            const imageUrlInput = document.getElementById('productImageUrl');
            imageUrlInput.addEventListener('input', () => updateImagePreview());
            imageUrlInput.addEventListener('change', () => updateImagePreview());
        }

        function updateImagePreview() {
            const url = document.getElementById('productImageUrl').value.trim();
            const container = document.getElementById('imagePreviewContainer');
            const img = document.getElementById('imagePreview');

            if (!url) {
                container.style.display = 'none';
                return;
            }

            img.onload = () => {
                container.style.display = 'block';
            };
            img.onerror = () => {
                container.style.display = 'none';
            };
            img.src = url;
        }

        async function loadProducts() {
            try {
                const response = await fetch('/products');
                if (response.ok) {
                    products = await response.json();
                    console.log('Loaded products:', products.length);
                }
            } catch (err) {
                console.error('Error loading products:', err);
            }
        }

        async function loadUsers() {
            try {
                const response = await fetch('/users');
                if (response.ok) {
                    users = await response.json();
                    console.log('Loaded users:', users.length);
                }
            } catch (err) {
                console.error('Error loading users:', err);
            }
        }

        function setupUserDropdown() {
            const searchInput = document.getElementById('userSearchInput');
            const dropdown = document.getElementById('userDropdown');

            searchInput.addEventListener('focus', () => {
                renderUserDropdown('');
                dropdown.classList.add('open');
            });

            searchInput.addEventListener('input', (e) => {
                renderUserDropdown(e.target.value);
                dropdown.classList.add('open');
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.user-dropdown-wrapper')) {
                    dropdown.classList.remove('open');
                }
            });
        }

        function renderUserDropdown(searchTerm) {
            const dropdown = document.getElementById('userDropdown');
            const lowerSearch = searchTerm.toLowerCase();

            let html = '';
            html += `<div class="product-option add-new" onclick="selectAddNewUser()">+ Add New User</div>`;

            const filtered = users.filter(u =>
                u.name.toLowerCase().includes(lowerSearch)
            );

            filtered.forEach((user, idx) => {
                const originalIdx = users.indexOf(user);
                const selectedClass = originalIdx === selectedUserIndex ? 'selected' : '';
                html += `
                    <div class="product-option ${selectedClass}">
                        <span class="product-option-name" onclick="selectUser(${originalIdx})">${user.name}</span>
                        <button class="product-delete-btn" onclick="event.stopPropagation(); deleteUser('${user.name.replace(/'/g, "\\'")}', ${originalIdx})" title="Delete user">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </div>
                `;
            });

            if (filtered.length === 0 && users.length > 0) {
                html += `<div class="product-option" style="color: #9CA3AF; cursor: default;">No users found</div>`;
            }

            dropdown.innerHTML = html;
        }

        function selectUser(index) {
            const user = users[index];
            if (!user) return;

            selectedUserIndex = index;
            isAddingNewUser = false;

            document.getElementById('userSearchInput').value = user.name;
            document.getElementById('userDropdown').classList.remove('open');
            document.getElementById('addUserSection').classList.remove('visible');

            // Fill measurement fields
            document.getElementById('chest_circumference').value = user.chest_circumference || '';
            document.getElementById('waist_circumference').value = user.waist_circumference || '';
            document.getElementById('hip_circumference').value = user.hip_circumference || '';
            document.getElementById('shoulder_breadth').value = user.shoulder_breadth || '';
            document.getElementById('neck_circumference').value = user.neck_circumference || '';
            document.getElementById('thigh_left_circumference').value = user.thigh_left_circumference || '';
            document.getElementById('ankle_left_circumference').value = user.ankle_left_circumference || '';
            document.getElementById('arm_right_length').value = user.arm_right_length || '';
            document.getElementById('inside_leg_height').value = user.inside_leg_height || '';
            document.getElementById('height').value = user.height || '';

            // Fill styling goals
            const checkboxes = document.querySelectorAll('input[name="styling_goal"]');
            checkboxes.forEach(cb => {
                cb.checked = user.styling_goals && user.styling_goals.includes(cb.value);
            });
            updateGoalsCheckboxState();
        }

        function selectAddNewUser() {
            isAddingNewUser = true;
            selectedUserIndex = -1;

            document.getElementById('userSearchInput').value = '';
            document.getElementById('userNameInput').value = '';
            document.getElementById('userDropdown').classList.remove('open');
            document.getElementById('addUserSection').classList.add('visible');
        }

        function cancelAddUser() {
            isAddingNewUser = false;
            document.getElementById('addUserSection').classList.remove('visible');
        }

        async function saveUser() {
            const name = document.getElementById('userNameInput').value.trim();

            if (!name) {
                alert('Please enter a user name');
                return;
            }

            const userData = {
                name,
                chest_circumference: parseFloat(document.getElementById('chest_circumference').value) || null,
                waist_circumference: parseFloat(document.getElementById('waist_circumference').value) || null,
                hip_circumference: parseFloat(document.getElementById('hip_circumference').value) || null,
                shoulder_breadth: parseFloat(document.getElementById('shoulder_breadth').value) || null,
                neck_circumference: parseFloat(document.getElementById('neck_circumference').value) || null,
                thigh_left_circumference: parseFloat(document.getElementById('thigh_left_circumference').value) || null,
                ankle_left_circumference: parseFloat(document.getElementById('ankle_left_circumference').value) || null,
                arm_right_length: parseFloat(document.getElementById('arm_right_length').value) || null,
                inside_leg_height: parseFloat(document.getElementById('inside_leg_height').value) || null,
                height: parseFloat(document.getElementById('height').value) || null,
                styling_goals: getSelectedStylingGoals()
            };

            try {
                const response = await fetch('/add-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    await loadUsers();
                    const newIndex = users.findIndex(u => u.name.toLowerCase() === name.toLowerCase());
                    if (newIndex >= 0) {
                        selectUser(newIndex);
                    }
                    document.getElementById('addUserSection').classList.remove('visible');
                    alert('User saved successfully!');
                } else {
                    alert('Error saving user: ' + (result.error || 'Unknown error'));
                }
            } catch (err) {
                alert('Error saving user: ' + err.message);
            }
        }

        async function deleteUser(name, index) {
            if (!confirm(`Are you sure you want to delete "${name}"?`)) {
                return;
            }

            try {
                const response = await fetch('/delete-user', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    if (selectedUserIndex === index) {
                        selectedUserIndex = -1;
                        document.getElementById('userSearchInput').value = '';
                    } else if (selectedUserIndex > index) {
                        selectedUserIndex--;
                    }

                    await loadUsers();
                    renderUserDropdown(document.getElementById('userSearchInput').value);
                } else {
                    alert('Error deleting user: ' + (result.error || 'Unknown error'));
                }
            } catch (err) {
                alert('Error deleting user: ' + err.message);
            }
        }

        function setupStylingGoals() {
            const checkboxes = document.querySelectorAll('input[name="styling_goal"]');
            checkboxes.forEach(cb => {
                cb.addEventListener('change', updateGoalsCheckboxState);
            });
            updateGoalsCheckboxState();
        }

        function updateGoalsCheckboxState() {
            const checkboxes = document.querySelectorAll('input[name="styling_goal"]');
            const checkedCount = document.querySelectorAll('input[name="styling_goal"]:checked').length;

            checkboxes.forEach(cb => {
                const label = cb.closest('.goal-checkbox');
                if (!cb.checked && checkedCount >= 3) {
                    label.classList.add('disabled');
                    cb.disabled = true;
                } else {
                    label.classList.remove('disabled');
                    cb.disabled = false;
                }
            });
        }

        function getSelectedStylingGoals() {
            const checked = document.querySelectorAll('input[name="styling_goal"]:checked');
            return Array.from(checked).map(cb => cb.value);
        }

        function getUserMeasurements() {
            return {
                chest_circumference: parseFloat(document.getElementById('chest_circumference').value) || null,
                waist_circumference: parseFloat(document.getElementById('waist_circumference').value) || null,
                hip_circumference: parseFloat(document.getElementById('hip_circumference').value) || null,
                shoulder_breadth: parseFloat(document.getElementById('shoulder_breadth').value) || null,
                neck_circumference: parseFloat(document.getElementById('neck_circumference').value) || null,
                thigh_left_circumference: parseFloat(document.getElementById('thigh_left_circumference').value) || null,
                ankle_left_circumference: parseFloat(document.getElementById('ankle_left_circumference').value) || null,
                arm_right_length: parseFloat(document.getElementById('arm_right_length').value) || null,
                inside_leg_height: parseFloat(document.getElementById('inside_leg_height').value) || null,
                height: parseFloat(document.getElementById('height').value) || null,
                styling_goals: getSelectedStylingGoals()
            };
        }

        function setupProductDropdown() {
            const searchInput = document.getElementById('productSearchInput');
            const dropdown = document.getElementById('productDropdown');

            // Show dropdown on focus
            searchInput.addEventListener('focus', () => {
                renderDropdown('');
                dropdown.classList.add('open');
            });

            // Filter on input
            searchInput.addEventListener('input', (e) => {
                renderDropdown(e.target.value);
                dropdown.classList.add('open');
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.product-dropdown-wrapper')) {
                    dropdown.classList.remove('open');
                }
            });
        }

        function renderDropdown(searchTerm) {
            const dropdown = document.getElementById('productDropdown');
            const lowerSearch = searchTerm.toLowerCase();

            let html = '';

            // Add "Add New Product" option at top
            html += `<div class="product-option add-new" onclick="selectAddNew()">+ Add New Product</div>`;

            // Filter and render products
            const filtered = products.filter(p =>
                p.name.toLowerCase().includes(lowerSearch)
            );

            filtered.forEach((product, idx) => {
                const originalIdx = products.indexOf(product);
                const selectedClass = originalIdx === selectedProductIndex ? 'selected' : '';
                const thumbHtml = product.product_image_url
                    ? `<img class="product-option-thumb" src="${product.product_image_url}" alt="" onerror="this.style.display='none'">`
                    : `<div class="product-option-thumb-placeholder">—</div>`;
                html += `
                    <div class="product-option ${selectedClass}">
                        ${thumbHtml}
                        <span class="product-option-name" onclick="selectProduct(${originalIdx})">${product.name}</span>
                        <button class="product-delete-btn" onclick="event.stopPropagation(); deleteProduct('${product.name.replace(/'/g, "\\'")}', ${originalIdx})" title="Delete product">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </div>
                `;
            });

            if (filtered.length === 0 && products.length > 0) {
                html += `<div class="product-option" style="color: #9CA3AF; cursor: default;">No products found</div>`;
            }

            dropdown.innerHTML = html;
        }

        function selectProduct(index) {
            const product = products[index];
            if (!product) return;

            selectedProductIndex = index;
            isAddingNew = false;

            // Update UI
            document.getElementById('productSearchInput').value = product.name;
            document.getElementById('productText').value = product.product_text || '';
            document.getElementById('productImageUrl').value = product.product_image_url || '';
            document.getElementById('productDropdown').classList.remove('open');
            document.getElementById('addProductSection').classList.remove('visible');
            updateImagePreview();
        }

        function selectAddNew() {
            isAddingNew = true;
            selectedProductIndex = -1;

            // Keep product text and image URL, only clear search input and product name
            document.getElementById('productSearchInput').value = '';
            document.getElementById('productNameInput').value = '';
            document.getElementById('productDropdown').classList.remove('open');
            document.getElementById('addProductSection').classList.add('visible');
        }

        function cancelAddProduct() {
            isAddingNew = false;
            document.getElementById('addProductSection').classList.remove('visible');
        }

        async function deleteProduct(name, index) {
            if (!confirm(`Are you sure you want to delete "${name}"?`)) {
                return;
            }

            try {
                const response = await fetch('/delete-product', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    // If we deleted the currently selected product, clear the selection
                    if (selectedProductIndex === index) {
                        selectedProductIndex = -1;
                        document.getElementById('productSearchInput').value = '';
                        document.getElementById('productText').value = '';
                        document.getElementById('productImageUrl').value = '';
                        updateImagePreview();
                    } else if (selectedProductIndex > index) {
                        // Adjust index if we deleted a product before the selected one
                        selectedProductIndex--;
                    }

                    // Reload products and re-render dropdown
                    await loadProducts();
                    renderDropdown(document.getElementById('productSearchInput').value);
                } else {
                    alert('Error deleting product: ' + (result.error || 'Unknown error'));
                }
            } catch (err) {
                alert('Error deleting product: ' + err.message);
            }
        }

        async function saveProduct() {
            const name = document.getElementById('productNameInput').value.trim();
            const productText = document.getElementById('productText').value;
            const productImageUrl = document.getElementById('productImageUrl').value;

            if (!name) {
                alert('Please enter a product name');
                return;
            }

            try {
                const response = await fetch('/add-product', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        product_text: productText,
                        product_image_url: productImageUrl
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    // Reload products and select the new one
                    await loadProducts();
                    const newIndex = products.findIndex(p => p.name.toLowerCase() === name.toLowerCase());
                    if (newIndex >= 0) {
                        selectProduct(newIndex);
                    }
                    document.getElementById('addProductSection').classList.remove('visible');
                    alert('Product saved successfully!');
                } else {
                    alert('Error saving product: ' + (result.error || 'Unknown error'));
                }
            } catch (err) {
                alert('Error saving product: ' + err.message);
            }
        }

        function renderResult(data) {
            const container = document.getElementById('resultDisplay');

            if (!data) {
                container.innerHTML = '';
                return;
            }

            // Check if product is not supported
            if (data.is_product_supported === false || data.is_product_supported === "false") {
                container.innerHTML = `
                    <div class="not-supported">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#9CA3AF" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                        <p style="margin-top: 12px;">This product isn't yet supported in the stylist.</p>
                    </div>
                `;
                return;
            }

            const comm = data.communication || {};
            const scoring = data.scoring_result || {};

            const verdictLabels = {
                this_is_it: 'This Is It!',
                smart_pick: 'Smart Pick',
                not_this_one: 'Not This One',
            };

            let html = '';

            // Score + Verdict Badge
            html += `
                <div class="score-badge">
                    <div class="score-number">
                        ${scoring.overall_score != null ? Number(scoring.overall_score).toFixed(1) : '—'}
                    </div>
                    <div>
                        <div class="verdict-chip">
                            ${verdictLabels[comm.verdict] || comm.verdict || '—'}
                        </div>
                        <div class="confidence-text">
                            Confidence: ${scoring.confidence != null ? (Number(scoring.confidence) * 100).toFixed(0) + '%' : '—'}
                        </div>
                    </div>
                </div>
            `;

            // Headline
            if (comm.headline) {
                html += `<div class="headline">${comm.headline}</div>`;
            }

            // Principle Scores (shown right after headline)
            if (scoring.principle_scores && scoring.principle_scores.length > 0) {
                html += `
                    <details class="collapsible">
                        <summary>Principle Scores</summary>
                        <div class="collapsible-content">
                            ${scoring.principle_scores.map((principle, i) => {
                                const reasonings = principle.prompt_input_reasoning || [];
                                if (reasonings.length === 0) return ''; // Skip principles with no reasoning
                                return `
                                    <div style="padding: 8px 0; border-bottom: ${i < scoring.principle_scores.length - 1 ? '1px solid #E5E7EB' : 'none'};">
                                        <div style="font-weight: 600; font-size: 12px; color: #374151; margin-bottom: 4px;">
                                            ${principle.name}
                                            ${principle.score != null ? `<span style="font-weight: 400; color: #6B7280;"> (${principle.score >= 0 ? '+' : ''}${Number(principle.score).toFixed(3)})</span>` : ''}
                                        </div>
                                        ${reasonings.map(r => `
                                            <div style="font-size: 12px; color: #4B5563; padding: 2px 0 2px 12px; border-left: 2px solid ${r.startsWith('Con:') ? '#FDE68A' : r.startsWith('Pro:') ? '#A7F3D0' : '#E5E7EB'};">
                                                ${r}
                                            </div>
                                        `).join('')}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </details>
                `;
            }

            // Pinch
            if (comm.pinch && comm.pinch.length > 0) {
                const pinchHtml = comm.pinch.map(seg => {
                    const text = typeof seg === 'object' ? seg.text : seg;
                    const isBold = typeof seg === 'object' && seg.style === 'bold';
                    return `<span style="font-weight: ${isBold ? '600' : '400'}">${text}</span>`;
                }).join('');
                html += `<div class="pinch-text">${pinchHtml}</div>`;
            }

            // User line
            if (comm.user_line) {
                html += `<div class="user-line">${comm.user_line}</div>`;
            }

            // Goal Chips
            if (comm.goal_chips && comm.goal_chips.length > 0) {
                html += `<div class="section-title">Goals</div>`;
                html += `<div class="goal-chips">`;
                comm.goal_chips.forEach(chip => {
                    const verdictClass = chip.verdict === 'helping' ? 'helping' :
                                        chip.verdict === 'fighting' ? 'fighting' : 'mixed';
                    html += `
                        <div class="goal-chip ${verdictClass}">
                            <span>${chip.icon || ''}</span>
                            <span>${chip.goal}</span>
                            <span style="font-size: 10px; opacity: 0.7;">(${chip.verdict})</span>
                        </div>
                    `;
                });
                html += `</div>`;
            }

            // Goal Verdicts - detailed breakdown
            if (scoring.goal_verdicts && scoring.goal_verdicts.length > 0) {
                html += `<div class="goal-analysis">`;
                html += `<div class="section-title">Goal Analysis</div>`;
                scoring.goal_verdicts.forEach(gv => {
                    const goalLabel = typeof gv.goal === 'object' ? (gv.goal.value || gv.goal) : gv.goal;
                    const verdictClass = gv.verdict === 'pass' ? 'pass' : gv.verdict === 'fail' ? 'fail' : '';
                    html += `
                        <div class="goal-item ${verdictClass}">
                            <div class="goal-header">
                                <span class="goal-name">${String(goalLabel).replace(/_/g, ' ')}</span>
                                <span class="goal-score">
                                    ${gv.verdict?.toUpperCase()} (${gv.score != null ? (gv.score >= 0 ? '+' : '') + Number(gv.score).toFixed(3) : '—'})
                                </span>
                            </div>
                            ${gv.reasoning ? `<div class="goal-reasoning">${gv.reasoning}</div>` : ''}
                            ${gv.supporting_principles && gv.supporting_principles.length > 0 ?
                                `<div class="goal-reasoning">Principles: ${gv.supporting_principles.join(', ')}</div>` : ''}
                        </div>
                    `;
                });
                html += `</div>`;
            }

            // Search pills
            if (comm.search_pills && comm.search_pills.length > 0) {
                html += `<div class="section-title">Try Instead</div>`;
                html += `<div class="goal-chips">`;
                comm.search_pills.forEach(pill => {
                    html += `<div class="goal-chip">${pill}</div>`;
                });
                html += `</div>`;
            }

            // Photo note / Confidence note
            if (comm.photo_note || comm.confidence_note) {
                html += `<div class="user-line">`;
                if (comm.photo_note) html += `<div>${comm.photo_note}</div>`;
                if (comm.confidence_note) html += `<div>${comm.confidence_note}</div>`;
                html += `</div>`;
            }

            // Collapsible sections

            // Full Stylist Take (from explanationResult)
            if (data.explanationResult && data.explanationResult.success && data.explanationResult.result) {
                const expResult = data.explanationResult.result;
                let stylistTakeContent = '';

                // Explanation paragraphs
                if (expResult.explanation) {
                    const explanationHtml = Array.isArray(expResult.explanation)
                        ? expResult.explanation.map((p, i) => `<p style="margin-bottom: ${i < expResult.explanation.length - 1 ? '12px' : '0'}">${p}</p>`).join('')
                        : `<p>${expResult.explanation}</p>`;
                    stylistTakeContent += `<div style="font-size: 13px; color: #374151; line-height: 1.7; margin-bottom: 12px;">${explanationHtml}</div>`;
                }

                // Key Benefits
                if (expResult.key_benefits && expResult.key_benefits.length > 0) {
                    stylistTakeContent += `
                        <div style="margin-bottom: 10px;">
                            <div style="font-size: 11px; font-weight: 600; color: #065F46; margin-bottom: 6px;">Key Benefits</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                ${expResult.key_benefits.map(b => `
                                    <span style="padding: 4px 10px; border-radius: 16px; font-size: 11px; background: #ECFDF5; color: #065F46; border: 1px solid #A7F3D0;">${b}</span>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                // Considerations
                if (expResult.considerations && expResult.considerations.length > 0) {
                    stylistTakeContent += `
                        <div>
                            <div style="font-size: 11px; font-weight: 600; color: #92400E; margin-bottom: 6px;">Considerations</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                ${expResult.considerations.map(c => `
                                    <span style="padding: 4px 10px; border-radius: 16px; font-size: 11px; background: #FFFBEB; color: #92400E; border: 1px solid #FDE68A;">${c}</span>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                html += `
                    <details class="collapsible">
                        <summary>Full Stylist Take</summary>
                        <div class="collapsible-content">
                            ${stylistTakeContent}
                        </div>
                    </details>
                `;
            }

            // Text Attributes
            if (data.textAttrs && Object.keys(data.textAttrs).length > 0) {
                html += `
                    <details class="collapsible">
                        <summary>Text Attributes</summary>
                        <div class="collapsible-content">
                            <pre>${JSON.stringify(data.textAttrs, null, 2)}</pre>
                        </div>
                    </details>
                `;
            }

            // Image Attributes
            if (data.imageAttrs && Object.keys(data.imageAttrs).length > 0) {
                html += `
                    <details class="collapsible">
                        <summary>Image Attributes</summary>
                        <div class="collapsible-content">
                            <pre>${JSON.stringify(data.imageAttrs, null, 2)}</pre>
                        </div>
                    </details>
                `;
            }

            // Merged Attributes
            if (data.mergedAttrs && Object.keys(data.mergedAttrs).length > 0) {
                html += `
                    <details class="collapsible">
                        <summary>Merged Attributes</summary>
                        <div class="collapsible-content">
                            <pre>${JSON.stringify(data.mergedAttrs, null, 2)}</pre>
                        </div>
                    </details>
                `;
            }

            // Reasoning Chain
            if (scoring.reasoning_chain && scoring.reasoning_chain.length > 0) {
                html += `
                    <details class="collapsible">
                        <summary>Reasoning Chain</summary>
                        <div class="collapsible-content">
                            ${scoring.reasoning_chain.map((item, i) => `
                                <div style="padding: 4px 0; border-bottom: ${i < scoring.reasoning_chain.length - 1 ? '1px solid #E5E7EB' : 'none'};">
                                    ${item}
                                </div>
                            `).join('')}
                        </div>
                    </details>
                `;
            }

            // Input Prompt
            if (data.explanationResult && data.explanationResult.result && data.explanationResult.result.input_prompt) {
                html += `
                    <details class="collapsible">
                        <summary>Input Prompt</summary>
                        <div class="collapsible-content">
                            <pre>${data.explanationResult.result.input_prompt}</pre>
                        </div>
                    </details>
                `;
            }

            container.innerHTML = html;
        }

        async function runPipeline() {
            const productText = document.getElementById('productText').value;
            const productImageUrl = document.getElementById('productImageUrl').value;
            const resultJson = document.getElementById('resultJson');
            const resultDisplay = document.getElementById('resultDisplay');
            const status = document.getElementById('status');
            const runBtn = document.getElementById('runBtn');

            if (!productText.trim() && !productImageUrl.trim()) {
                status.textContent = 'Please enter product text or image URL';
                status.className = 'status error';
                status.style.display = 'block';
                return;
            }

            // Show loading state
            runBtn.disabled = true;
            runBtn.textContent = 'Running...';
            status.textContent = 'Running pipeline...';
            status.className = 'status loading';
            status.style.display = 'block';
            resultJson.value = '';
            resultDisplay.innerHTML = `
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <span style="color: #6B7280;">Running pipeline...</span>
                </div>
            `;

            try {
                const useCache = document.getElementById('useCacheCheckbox').checked;

                const response = await fetch('/run-pipeline', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        product_text: productText,
                        product_image_url: productImageUrl,
                        user_measurements: getUserMeasurements(),
                        use_cache: useCache
                    })
                });

                const result = await response.json();
                resultJson.value = JSON.stringify(result, null, 2);

                if (response.ok) {
                    renderResult(result);
                    status.textContent = 'Pipeline completed successfully!';
                    status.className = 'status success';
                } else {
                    resultDisplay.innerHTML = `<div class="not-supported"><p>Error: ${result.error || 'Unknown error'}</p></div>`;
                    status.textContent = 'Pipeline error: ' + (result.error || 'Unknown error');
                    status.className = 'status error';
                }
            } catch (err) {
                status.textContent = 'Network error: ' + err.message;
                status.className = 'status error';
                resultJson.value = JSON.stringify({ error: err.message }, null, 2);
                resultDisplay.innerHTML = `<div class="not-supported"><p>Network error: ${err.message}</p></div>`;
            } finally {
                runBtn.disabled = false;
                runBtn.textContent = 'Run Pipeline';
            }
        }
    </script>
</body>
</html>
